---
# tasks file for Linux COE
# filename: roles/COE/tasks/main.yml
- name: Common Operating Environment
  hosts: all
  user: rudebwoy
  become_user: root
  become: yes
  become_method: sudo
  vars_files:
  - ../../../group_vars/COE.yml

  # Install COE packages...
  tasks:
  # ...for OpenSUSE Leap 15 systems.
  - name: Install COE packages (OpenSUSE Leap 15)
    zypper: name={{ OpenSUSE_15_Packages }} state=installed
    when:
      - ansible_facts['distribution'] == "openSUSE Leap"
      - ansible_facts['distribution_major_version'] == "15"

  # ...for Red Hat Enterprise Linux 8 systems.
  - name: Install COE packages (RedHat 8)
    yum: name={{ RedHat_8_Packages }} state=installed
    when:
      - ansible_facts['distribution'] == "RedHat"
      - ansible_facts['distribution_major_version'] == "8"

  # ...for Red Hat Enterprise Linux 8 systems.
  - name: Install COE packages (RedHat 8)
    yum: name={{ RedHat_8_Packages }} state=installed
    when:
      - ansible_facts['distribution'] == "RedHat"
      - ansible_facts['distribution_major_version'] == "9"

  # Update all packages on RHEL 8+ systems.
  - name: Update all packages (Red Hat 8)
    dnf: name=* state=latest update_cache=yes
    when:
      - ansible_facts['distribution'] == "RedHat"
      - ansible_facts['distribution_major_version'] =+ "8"

  # Update all packages on OpenSUSE systems.
  - name: Update all packages (OpenSUSE)
    zypper: name=* state=latest update_cache=yes
    when:
      - ansible_facts['distribution'] == "openSUSE Leap"
      - ansible_facts['distribution_major_version'] == "15"

  # Update /etc/resolv.conf
  - name: (OpenSUSE) Set DNS search list
    lineinfile:
      path: /etc/sysconfig/network/config
      regexp: '^NETCONFIG_DNS_STATIC_SEARCHLIST='
      line: NETCONFIG_DNS_STATIC_SEARCHLIST="yard.lo"
    when:
      - ansible_facts['distribution'] == "openSUSE Leap"
      - ansible_facts['distribution_major_version'] == "15"

  - name: (OpenSUSE) Set DNS servers
    lineinfile:
      path: /etc/sysconfig/network/config
      regexp: '^NETCONFIG_DNS_STATIC_SERVERS='
      line: NETCONFIG_DNS_STATIC_SERVERS="192.168.1.9"
    when:
      - ansible_facts['distribution'] == "openSUSE Leap"
      - ansible_facts['distribution_major_version'] == "15"

  - name: (OpenSUSE) Set DNS options
    lineinfile:
      path: /etc/sysconfig/network/config
      regexp: '^NETCONFIG_DNS_RESOLVER_OPTIONS='
      line: NETCONFIG_DNS_RESOLVER_OPTIONS="attempts:1 timeout:2"
    when:
      - ansible_facts['distribution'] == "openSUSE Leap"
      - ansible_facts['distribution_major_version'] == "15"

  - name: (OpenSUSE) Generate /etc/resolv.conf
    shell: netconfig update -f
    when:
      - ansible_facts['distribution'] == "openSUSE Leap"
      - ansible_facts['distribution_major_version'] == "15"

  - name: (Red Hat) Copy /etc/resolv.conf
    copy:
      src: ../files/resolv.conf
      dest: /etc/resolv.conf
      owner: root
      group: root
      mode: 0644
      backup: yes
    when:
      - ansible_facts['distribution'] == "RedHat"
      - ansible_facts['distribution_major_version'] == "8"

   - name: (Red Hat) Install EPEL Repo
     import_playbook: install_epel.yml
     when:
      - ansible_facts['distribution'] == "RedHat"
      - ansible_facts['distribution_major_version'] == "8"

