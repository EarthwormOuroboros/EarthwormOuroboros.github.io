---
# tasks file for Linux COE
# filename: roles/COE/tasks/main.yml
- hosts: all
  user: rudebwoy
  become_user: root
  become: yes
  become_method: sudo
  vars_files:
  - ../../../group_vars/COE-packages.yml

  # Install COE packages...
  tasks:
  # ...for CentOS 7 systems.
  - name: Install COE packages (CentOS 7)
    yum: name={{ CentOS_7_Packages }} state=installed
    when:
      - ansible_facts['distribution'] == "CentOS"
      - ansible_facts['distribution_major_version'] == "7"

  # ...for CentOS 8 systems.
  - name: Install COE packages (CentOS 8)
    yum: name={{ CentOS_8_Packages }} state=installed
    when:
      - ansible_facts['distribution'] == "CentOS"
      - ansible_facts['distribution_major_version'] == "8"

  # ...for OpenSUSE Leap 15 systems.
  - name: Install COE packages (OpenSUSE Leap 15)
    zypper: name={{ OpenSUSE_15_Packages }} state=installed
    when:
      - ansible_facts['distribution'] == "openSUSE Leap"
      - ansible_facts['distribution_major_version'] == "15"

  # ...for Red Hat Enterprise Linux 8 systems.
  - name: Install COE packages (RedHat 8)
    yum: name={{ RedHat_8_Packages }} state=installed
    when:
      - ansible_facts['distribution'] == "RedHat"
      - ansible_facts['distribution_major_version'] == "8"

  # Update all packages on RHEL and CentOS 8 systems.
  - name: Update all packages (Red Hat 8)
    dnf: name=* state=latest update_cache=yes
    when:
      - ansible_facts['distribution'] == "RedHat" or ansible_facts['distribution'] == "CentOS"
      - ansible_facts['distribution_major_version'] == "8"

# Update all apackages on CentOS 7 systems.
  - name: Update all packages (CentOS 7)
    yum: name=* state=latest update_cache=yes
    when:
      - ansible_facts['distribution'] == "CentOS"
      - ansible_facts['distribution_major_version'] == "7"

# Update all packages on OpenSUSE systems.
  - name: Update all packages (OpenSUSE)
    zypper: name=* state=latest update_cache=yes
    when:
      - ansible_facts['distribution'] == "openSUSE Leap"
      - ansible_facts['distribution_major_version'] == "15"

# Update /etc/resolv.conf
  - name: (OpenSUSE) Set DNS search list
    lineinfile:
      path: /etc/sysconfig/network/config
      regexp: '^NETCONFIG_DNS_STATIC_SEARCHLIST='
      line: NETCONFIG_DNS_STATIC_SEARCHLIST="cyfd.state.nm.us ad.cyfd.state.nm.us state.nm.us"
    when:
      - ansible_facts['distribution'] == "openSUSE Leap"
      - ansible_facts['distribution_major_version'] == "15"

  - name: (OpenSUSE) Set DNS servers
    lineinfile:
      path: /etc/sysconfig/network/config
      regexp: '^NETCONFIG_DNS_STATIC_SERVERS='
      line: NETCONFIG_DNS_STATIC_SERVERS="10.1.201.31 10.1.201.32 10.148.201.31 10.148.201.32"
    when:
      - ansible_facts['distribution'] == "openSUSE Leap"
      - ansible_facts['distribution_major_version'] == "15"

  - name: (OpenSUSE) Set DNS options
    lineinfile:
      path: /etc/sysconfig/network/config
      regexp: '^NETCONFIG_DNS_RESOLVER_OPTIONS='
      line: NETCONFIG_DNS_RESOLVER_OPTIONS="attempts:1 timeout:2"
    when:
      - ansible_facts['distribution'] == "openSUSE Leap"
      - ansible_facts['distribution_major_version'] == "15"

  - name: (OpenSUSE) Generate /etc/resolv.conf
    shell: netconfig update -f
    when:
      - ansible_facts['distribution'] == "openSUSE Leap"
      - ansible_facts['distribution_major_version'] == "15"

  - name: (Red Hat) Copy /etc/resolv.conf
    copy:
      src: ../files/resolv.conf
      dest: /etc/resolv.conf
      owner: root
      group: root
      mode: 0644
      backup: yes
    when:
      - ansible_facts['distribution'] == "RedHat"
      - ansible_facts['distribution_major_version'] == "8"


#  import_playbook: foo.yaml
#    when:
#      - ansible_facts['distribution'] == "CentOS"
#      - ansible_facts['distribution_major_version'] == "7"

#  - hosts: localhost
#    tasks:
#      - debug:
#          msg: play1

#  - name: Include a play after another play
#    import_playbook: otherplays.yaml

#  - name: Set variables on an imported playbook
#    import_playbook: otherplays.yml
#    vars:
#      service: httpd
